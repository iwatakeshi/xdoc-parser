"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const remark = require("remark");
const XDocCommentParser_1 = require("./XDocCommentParser");
const XDocASTGenerator_1 = require("./XDocASTGenerator");
const XDocASTVisitor_1 = require("./XDocASTVisitor");
class XDocParser {
    constructor(source, options) {
        this.options = {
            comment: {
                type: 'DOUBLE_STAR_COMMENT'
            },
            markdown: {
                remark: {},
                headingDepth: 2
            },
            visitor: {}
        };
        /**
         * Parse a single comment.
         *
         * @return: {
         *  markdown: RemarkNode[],
         *  documentation: Partial<DocumentationNode>
         * }
         */
        this.parse = () => {
            const comment = (new XDocCommentParser_1.default(this.source))
                .parse()
                .filter(this.filter)[0];
            return {
                markdown: comment ? this.parseMarkdown(comment.text) : null,
                documentation: comment ? this.parseXDoc(comment.text) : null
            };
        };
        /**
         * Parse multiple comments within a file.
         */
        this.parseFile = () => {
            const comments = (new XDocCommentParser_1.default(this.source))
                .parse()
                .filter(this.filter);
            return comments.map(token => ({
                markdown: this.parseMarkdown(token.text),
                documentation: this.parseXDoc(token.text)
            }));
        };
        this.parseSyntax = () => {
            return this.parseXDoc(this.source);
        };
        this.parseMarkdown = (source) => {
            let ast = remark()
                .data('settings', this.options.markdown.remark)
                .parse(source);
            ast.children = ast.children.map((node, index) => {
                if (node.type === 'heading') {
                    node.depth = this.options.markdown.headingDepth;
                }
                if (node.type === 'code') {
                    if (this.isAPI(ast.children[index - 1])) {
                        if (!node.lang)
                            node.lang = 'xdoc';
                        return node;
                    }
                }
                return node;
            });
            return ast;
        };
        this.isAPI = (node) => {
            return node && node.type === "heading" && node.children[0].value.toLowerCase() === "api";
        };
        this.parseXDoc = (source) => {
            const XDocRegex = /@(\w+)([^{[(\n]*)?([\{\[\(][\s\S]*[\}\]\)]([\s]*(=|-)>.*)?)?([\s]*-(.)*)?/gmi;
            const syntaxes = source.match(XDocRegex) || [''];
            const documentation = (new XDocASTGenerator_1.default(syntaxes.join('\n'))).generate();
            return (new XDocASTVisitor_1.default(documentation, this.options.visitor)
                .visit());
        };
        this.filter = (token) => {
            return XDocCommentParser_1.TokenType[token.type] === this.options.comment.type;
        };
        this.source_ = source;
        Object.assign(this.options, options || {});
    }
    get source() {
        return this.source_;
    }
}
exports.default = XDocParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWERvY1BhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9YRG9jUGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQWlDO0FBQ2pDLDJEQUEwRTtBQUMxRSx5REFBa0Q7QUFDbEQscURBQXlFO0FBOEJ6RSxNQUFxQixVQUFVO0lBYTdCLFlBQVksTUFBYyxFQUFFLE9BQW9DO1FBWHhELFlBQU8sR0FBc0I7WUFDbkMsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSxxQkFBcUI7YUFDNUI7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsWUFBWSxFQUFFLENBQUM7YUFDaEI7WUFDRCxPQUFPLEVBQUUsRUFBRTtTQUNaLENBQUE7UUFXRDs7Ozs7OztXQU9HO1FBQ0gsVUFBSyxHQUFHLEdBQUcsRUFBRTtZQUNYLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBSSwyQkFBaUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ2pELEtBQUssRUFBRTtpQkFDUCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFCLE9BQU87Z0JBQ0wsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQyxDQUFDLElBQUk7Z0JBQzFELGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUMsQ0FBQyxJQUFJO2FBQzVELENBQUE7UUFDSCxDQUFDLENBQUE7UUFFRDs7V0FFRztRQUNILGNBQVMsR0FBRyxHQUFHLEVBQUU7WUFDZixNQUFNLFFBQVEsR0FBRyxDQUFDLElBQUksMkJBQWlCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNsRCxLQUFLLEVBQUU7aUJB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QUVELElBQVcsTUFBTTtRQUNmLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0NBd0VGO0FBNUZELDZCQTRGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHJlbWFyayBmcm9tIFwicmVtYXJrXCI7XG5pbXBvcnQgWERvY0NvbW1lbnRQYXJzZXIsIHsgVG9rZW4sIFRva2VuVHlwZSB9IGZyb20gJy4vWERvY0NvbW1lbnRQYXJzZXInO1xuaW1wb3J0IFhEb2NBU1RHZW5lcmF0b3IgZnJvbSBcIi4vWERvY0FTVEdlbmVyYXRvclwiO1xuaW1wb3J0IFhEb2NBU1RWaXNpdG9yLCB7IFhEb2NBU1RWaXNpdG9yT3B0aW9ucyB9IGZyb20gXCIuL1hEb2NBU1RWaXNpdG9yXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgWERvY1BhcnNlck9wdGlvbnMge1xuICBjb21tZW50OiB7XG4gICAgdHlwZT86ICdTSU5HTEVfSEFTSF9DT01NRU5UJ1xuICAgIHwgJ1NJTkdMRV9TVEFSX0NPTU1FTlQnXG4gICAgfCAnRE9VQkxFX1NUQVJfQ09NTUVOVCdcbiAgICB8ICdET1VCTEVfU0xBU0hfQ09NTUVOVCdcbiAgICB8ICdUUklQTEVfU0xBU0hfQ09NTUVOVCdcbiAgICB8ICdUUklQTEVfUVVPVEVfQ09NTUVOVCdcbiAgfVxuICBtYXJrZG93bjoge1xuICAgIHJlbWFyaz86IGFueSxcbiAgICBoZWFkaW5nRGVwdGg/OiBudW1iZXJcbiAgfVxuICB2aXNpdG9yOiBYRG9jQVNUVmlzaXRvck9wdGlvbnMgfCBhbnlcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZW1hcmtOb2RlIHtcbiAgdHlwZTogc3RyaW5nLFxuICBkZXB0aD86IG51bWJlcixcbiAgdmFsdWU/OiBzdHJpbmcsXG4gIGxhbmc/OiBzdHJpbmdcbiAgY2hpbGRyZW46IFJlbWFya05vZGVbXSxcbiAgcG9zaXRpb246IHtcbiAgICBzdGFydDogbnVtYmVyLFxuICAgIGVuZDogbnVtYmVyXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgWERvY1BhcnNlciB7XG4gIHByaXZhdGUgc291cmNlXzogc3RyaW5nO1xuICBwcml2YXRlIG9wdGlvbnM6IFhEb2NQYXJzZXJPcHRpb25zID0ge1xuICAgIGNvbW1lbnQ6IHtcbiAgICAgIHR5cGU6ICdET1VCTEVfU1RBUl9DT01NRU5UJ1xuICAgIH0sXG4gICAgbWFya2Rvd246IHtcbiAgICAgIHJlbWFyazoge30sXG4gICAgICBoZWFkaW5nRGVwdGg6IDJcbiAgICB9LFxuICAgIHZpc2l0b3I6IHt9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihzb3VyY2U6IHN0cmluZywgb3B0aW9ucz86IFBhcnRpYWw8WERvY1BhcnNlck9wdGlvbnM+KSB7XG4gICAgdGhpcy5zb3VyY2VfID0gc291cmNlO1xuICAgIE9iamVjdC5hc3NpZ24odGhpcy5vcHRpb25zLCBvcHRpb25zIHx8IHt9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc291cmNlKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc291cmNlXztcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSBhIHNpbmdsZSBjb21tZW50LlxuICAgKiBcbiAgICogQHJldHVybjoge1xuICAgKiAgbWFya2Rvd246IFJlbWFya05vZGVbXSxcbiAgICogIGRvY3VtZW50YXRpb246IFBhcnRpYWw8RG9jdW1lbnRhdGlvbk5vZGU+XG4gICAqIH1cbiAgICovXG4gIHBhcnNlID0gKCkgPT4ge1xuICAgIGNvbnN0IGNvbW1lbnQgPSAobmV3IFhEb2NDb21tZW50UGFyc2VyKHRoaXMuc291cmNlKSlcbiAgICAgIC5wYXJzZSgpXG4gICAgICAuZmlsdGVyKHRoaXMuZmlsdGVyKVswXTtcbiAgICByZXR1cm4ge1xuICAgICAgbWFya2Rvd246IGNvbW1lbnQgPyB0aGlzLnBhcnNlTWFya2Rvd24oY29tbWVudC50ZXh0KTogbnVsbCxcbiAgICAgIGRvY3VtZW50YXRpb246IGNvbW1lbnQgPyB0aGlzLnBhcnNlWERvYyhjb21tZW50LnRleHQpOiBudWxsXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlIG11bHRpcGxlIGNvbW1lbnRzIHdpdGhpbiBhIGZpbGUuXG4gICAqL1xuICBwYXJzZUZpbGUgPSAoKSA9PiB7XG4gICAgY29uc3QgY29tbWVudHMgPSAobmV3IFhEb2NDb21tZW50UGFyc2VyKHRoaXMuc291cmNlKSlcbiAgICAgIC5wYXJzZSgpXG4gICAgICAuZmlsdGVyKHRoaXMuZmlsdGVyKTtcbiAgICByZXR1cm4gY29tbWVudHMubWFwKHRva2VuID0+ICh7XG4gICAgICBtYXJrZG93bjogdGhpcy5wYXJzZU1hcmtkb3duKHRva2VuLnRleHQpLFxuICAgICAgZG9jdW1lbnRhdGlvbjogdGhpcy5wYXJzZVhEb2ModG9rZW4udGV4dClcbiAgICB9KSlcbiAgfVxuXG4gIHBhcnNlU3ludGF4ID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLnBhcnNlWERvYyh0aGlzLnNvdXJjZSk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlTWFya2Rvd24gPSAoc291cmNlOiBzdHJpbmcpOiBSZW1hcmtOb2RlID0+IHtcbiAgICBsZXQgYXN0ID0gcmVtYXJrKClcbiAgICAgIC5kYXRhKCdzZXR0aW5ncycsIHRoaXMub3B0aW9ucy5tYXJrZG93bi5yZW1hcmspXG4gICAgICAucGFyc2Uoc291cmNlKSBhcyBSZW1hcmtOb2RlO1xuICAgIGFzdC5jaGlsZHJlbiA9IGFzdC5jaGlsZHJlbi5tYXAoKG5vZGUsIGluZGV4KSA9PiB7XG4gICAgICBpZiAobm9kZS50eXBlID09PSAnaGVhZGluZycpIHtcbiAgICAgICAgbm9kZS5kZXB0aCA9IHRoaXMub3B0aW9ucy5tYXJrZG93bi5oZWFkaW5nRGVwdGg7XG4gICAgICB9XG4gICAgICBpZiAobm9kZS50eXBlID09PSAnY29kZScpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNBUEkoYXN0LmNoaWxkcmVuW2luZGV4IC0gMV0pKSB7XG4gICAgICAgICAgaWYgKCFub2RlLmxhbmcpIG5vZGUubGFuZyA9ICd4ZG9jJztcbiAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIG5vZGU7XG4gICAgfSlcbiAgICByZXR1cm4gYXN0O1xuICB9XG5cbiAgcHJpdmF0ZSBpc0FQSSA9IChub2RlKSA9PiB7XG4gICAgcmV0dXJuIG5vZGUgJiYgbm9kZS50eXBlID09PSBcImhlYWRpbmdcIiAmJiBub2RlLmNoaWxkcmVuWzBdLnZhbHVlLnRvTG93ZXJDYXNlKCkgPT09IFwiYXBpXCI7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlWERvYyA9IChzb3VyY2U6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IFhEb2NSZWdleCA9IC9AKFxcdyspKFtee1soXFxuXSopPyhbXFx7XFxbXFwoXVtcXHNcXFNdKltcXH1cXF1cXCldKFtcXHNdKig9fC0pPi4qKT8pPyhbXFxzXSotKC4pKik/L2dtaTtcbiAgICBjb25zdCBzeW50YXhlcyA9IHNvdXJjZS5tYXRjaChYRG9jUmVnZXgpIHx8IFsnJ107XG4gICAgY29uc3QgZG9jdW1lbnRhdGlvbiA9IChuZXcgWERvY0FTVEdlbmVyYXRvcihzeW50YXhlcy5qb2luKCdcXG4nKSkpLmdlbmVyYXRlKCk7XG4gICAgcmV0dXJuIChuZXcgWERvY0FTVFZpc2l0b3IoZG9jdW1lbnRhdGlvbiwgdGhpcy5vcHRpb25zLnZpc2l0b3IpXG4gICAgICAudmlzaXQoKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGZpbHRlciA9ICh0b2tlbjogVG9rZW4pID0+IHtcbiAgICByZXR1cm4gVG9rZW5UeXBlW3Rva2VuLnR5cGVdID09PSB0aGlzLm9wdGlvbnMuY29tbWVudC50eXBlO1xuICB9XG59Il19