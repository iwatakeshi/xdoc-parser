"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const remark = require("remark");
const XDocCommentParser_1 = require("./XDocCommentParser");
const XDocASTGenerator_1 = require("./XDocASTGenerator");
const XDocASTVisitor_1 = require("./XDocASTVisitor");
class XDocParser {
    constructor(source, options) {
        this.options = {
            comment: {
                type: 'DOUBLE_STAR_COMMENT'
            },
            markdown: {
                remark: {},
                headingDepth: 2
            },
            visitor: {}
        };
        /**
         * Parse a single comment.
         *
         * @return: {
         *  markdown: RemarkNode[],
         *  documentation: Partial<DocumentationNode>
         * }
         */
        this.parse = () => {
            const comment = (new XDocCommentParser_1.default(this.source))
                .parse()
                .filter(this.filter)[0];
            return {
                markdown: comment ? this.parseMarkdown(comment.text) : null,
                documentation: comment ? this.parseXDoc(comment.text) : null
            };
        };
        /**
         * Parse multiple comments within a file.
         */
        this.parseFile = () => {
            const comments = (new XDocCommentParser_1.default(this.source))
                .parse()
                .filter(this.filter);
            return comments.map(token => ({
                markdown: this.parseMarkdown(token.text),
                documentation: this.parseXDoc(token.text)
            }));
        };
        this.parseSyntax = () => {
            return this.parseXDoc(this.source);
        };
        this.parseMarkdown = (source) => {
            let ast = remark()
                .data('settings', this.options.markdown.remark)
                .parse(source);
            ast.children = ast.children.map((node, index) => {
                if (node.type === 'heading') {
                    node.depth = this.options.markdown.headingDepth;
                }
                if (node.type === 'code') {
                    if (this.isAPI(ast.children[index - 1])) {
                        if (!node.lang)
                            node.lang = 'xdoc';
                        return node;
                    }
                }
                return node;
            });
            return ast;
        };
        this.isAPI = (node) => {
            return node && node.type === "heading" && node.children[0].value.toLowerCase() === "api";
        };
        this.parseXDoc = (source) => {
            const XDocRegex = /@(\w+)([^{[(\n]*)?([\{\[\(][\s\S]*[\}\]\)]([\s]*(=|-)>.*)?)?([\s]*-(.)*)?/gmi;
            const syntaxes = source.match(XDocRegex) || [''];
            const documentation = (new XDocASTGenerator_1.default(syntaxes.join('\n'))).generate();
            return (new XDocASTVisitor_1.default(documentation, this.options.visitor)
                .visit());
        };
        this.filter = (token) => {
            return XDocCommentParser_1.TokenType[token.type] === this.options.comment.type;
        };
        this.source_ = source;
        Object.assign(this.options, options || {});
    }
    get source() {
        return this.source_;
    }
}
exports.default = XDocParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWERvY1BhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9YRG9jUGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQWlDO0FBQ2pDLDJEQUEwRTtBQUMxRSx5REFBa0Q7QUFDbEQscURBQXlFO0FBOEJ6RTtJQWFFLFlBQVksTUFBYyxFQUFFLE9BQW9DO1FBWHhELFlBQU8sR0FBc0I7WUFDbkMsT0FBTyxFQUFFO2dCQUNQLElBQUksRUFBRSxxQkFBcUI7YUFDNUI7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsWUFBWSxFQUFFLENBQUM7YUFDaEI7WUFDRCxPQUFPLEVBQUUsRUFBRTtTQUNaLENBQUE7UUFXRDs7Ozs7OztXQU9HO1FBQ0gsVUFBSyxHQUFHLEdBQUcsRUFBRTtZQUNYLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBSSwyQkFBaUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ2pELEtBQUssRUFBRTtpQkFDUCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFCLE9BQU87Z0JBQ0wsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQyxDQUFDLElBQUk7Z0JBQzFELGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUMsQ0FBQyxJQUFJO2FBQzVELENBQUE7UUFDSCxDQUFDLENBQUE7UUFFRDs7V0FFRztRQUNILGNBQVMsR0FBRyxHQUFHLEVBQUU7WUFDZixNQUFNLFFBQVEsR0FBRyxDQUFDLElBQUksMkJBQWlCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNsRCxLQUFLLEVBQUU7aUJBQ1AsTUFBTSxDQUFD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TTtRQUNmLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0NBd0VGO0FBNUZELDZCQTRGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHJlbWFyayBmcm9tIFwicmVtYXJrXCI7XHJcbmltcG9ydCBYRG9jQ29tbWVudFBhcnNlciwgeyBUb2tlbiwgVG9rZW5UeXBlIH0gZnJvbSAnLi9YRG9jQ29tbWVudFBhcnNlcic7XHJcbmltcG9ydCBYRG9jQVNUR2VuZXJhdG9yIGZyb20gXCIuL1hEb2NBU1RHZW5lcmF0b3JcIjtcclxuaW1wb3J0IFhEb2NBU1RWaXNpdG9yLCB7IFhEb2NBU1RWaXNpdG9yT3B0aW9ucyB9IGZyb20gXCIuL1hEb2NBU1RWaXNpdG9yXCI7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFhEb2NQYXJzZXJPcHRpb25zIHtcclxuICBjb21tZW50OiB7XHJcbiAgICB0eXBlPzogJ1NJTkdMRV9IQVNIX0NPTU1FTlQnXHJcbiAgICB8ICdTSU5HTEVfU1RBUl9DT01NRU5UJ1xyXG4gICAgfCAnRE9VQkxFX1NUQVJfQ09NTUVOVCdcclxuICAgIHwgJ0RPVUJMRV9TTEFTSF9DT01NRU5UJ1xyXG4gICAgfCAnVFJJUExFX1NMQVNIX0NPTU1FTlQnXHJcbiAgICB8ICdUUklQTEVfUVVPVEVfQ09NTUVOVCdcclxuICB9XHJcbiAgbWFya2Rvd246IHtcclxuICAgIHJlbWFyaz86IGFueSxcclxuICAgIGhlYWRpbmdEZXB0aD86IG51bWJlclxyXG4gIH1cclxuICB2aXNpdG9yOiBYRG9jQVNUVmlzaXRvck9wdGlvbnMgfCBhbnlcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZW1hcmtOb2RlIHtcclxuICB0eXBlOiBzdHJpbmcsXHJcbiAgZGVwdGg/OiBudW1iZXIsXHJcbiAgdmFsdWU/OiBzdHJpbmcsXHJcbiAgbGFuZz86IHN0cmluZ1xyXG4gIGNoaWxkcmVuOiBSZW1hcmtOb2RlW10sXHJcbiAgcG9zaXRpb246IHtcclxuICAgIHN0YXJ0OiBudW1iZXIsXHJcbiAgICBlbmQ6IG51bWJlclxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgWERvY1BhcnNlciB7XHJcbiAgcHJpdmF0ZSBzb3VyY2VfOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBvcHRpb25zOiBYRG9jUGFyc2VyT3B0aW9ucyA9IHtcclxuICAgIGNvbW1lbnQ6IHtcclxuICAgICAgdHlwZTogJ0RPVUJMRV9TVEFSX0NPTU1FTlQnXHJcbiAgICB9LFxyXG4gICAgbWFya2Rvd246IHtcclxuICAgICAgcmVtYXJrOiB7fSxcclxuICAgICAgaGVhZGluZ0RlcHRoOiAyXHJcbiAgICB9LFxyXG4gICAgdmlzaXRvcjoge31cclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKHNvdXJjZTogc3RyaW5nLCBvcHRpb25zPzogUGFydGlhbDxYRG9jUGFyc2VyT3B0aW9ucz4pIHtcclxuICAgIHRoaXMuc291cmNlXyA9IHNvdXJjZTtcclxuICAgIE9iamVjdC5hc3NpZ24odGhpcy5vcHRpb25zLCBvcHRpb25zIHx8IHt9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQgc291cmNlKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5zb3VyY2VfO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUGFyc2UgYSBzaW5nbGUgY29tbWVudC5cclxuICAgKiBcclxuICAgKiBAcmV0dXJuOiB7XHJcbiAgICogIG1hcmtkb3duOiBSZW1hcmtOb2RlW10sXHJcbiAgICogIGRvY3VtZW50YXRpb246IFBhcnRpYWw8RG9jdW1lbnRhdGlvbk5vZGU+XHJcbiAgICogfVxyXG4gICAqL1xyXG4gIHBhcnNlID0gKCkgPT4ge1xyXG4gICAgY29uc3QgY29tbWVudCA9IChuZXcgWERvY0NvbW1lbnRQYXJzZXIodGhpcy5zb3VyY2UpKVxyXG4gICAgICAucGFyc2UoKVxyXG4gICAgICAuZmlsdGVyKHRoaXMuZmlsdGVyKVswXTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG1hcmtkb3duOiBjb21tZW50ID8gdGhpcy5wYXJzZU1hcmtkb3duKGNvbW1lbnQudGV4dCk6IG51bGwsXHJcbiAgICAgIGRvY3VtZW50YXRpb246IGNvbW1lbnQgPyB0aGlzLnBhcnNlWERvYyhjb21tZW50LnRleHQpOiBudWxsXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQYXJzZSBtdWx0aXBsZSBjb21tZW50cyB3aXRoaW4gYSBmaWxlLlxyXG4gICAqL1xyXG4gIHBhcnNlRmlsZSA9ICgpID0+IHtcclxuICAgIGNvbnN0IGNvbW1lbnRzID0gKG5ldyBYRG9jQ29tbWVudFBhcnNlcih0aGlzLnNvdXJjZSkpXHJcbiAgICAgIC5wYXJzZSgpXHJcbiAgICAgIC5maWx0ZXIodGhpcy5maWx0ZXIpO1xyXG4gICAgcmV0dXJuIGNvbW1lbnRzLm1hcCh0b2tlbiA9PiAoe1xyXG4gICAgICBtYXJrZG93bjogdGhpcy5wYXJzZU1hcmtkb3duKHRva2VuLnRleHQpLFxyXG4gICAgICBkb2N1bWVudGF0aW9uOiB0aGlzLnBhcnNlWERvYyh0b2tlbi50ZXh0KVxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICBwYXJzZVN5bnRheCA9ICgpID0+IHtcclxuICAgIHJldHVybiB0aGlzLnBhcnNlWERvYyh0aGlzLnNvdXJjZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBhcnNlTWFya2Rvd24gPSAoc291cmNlOiBzdHJpbmcpOiBSZW1hcmtOb2RlID0+IHtcclxuICAgIGxldCBhc3QgPSByZW1hcmsoKVxyXG4gICAgICAuZGF0YSgnc2V0dGluZ3MnLCB0aGlzLm9wdGlvbnMubWFya2Rvd24ucmVtYXJrKVxyXG4gICAgICAucGFyc2Uoc291cmNlKSBhcyBSZW1hcmtOb2RlO1xyXG4gICAgYXN0LmNoaWxkcmVuID0gYXN0LmNoaWxkcmVuLm1hcCgobm9kZSwgaW5kZXgpID0+IHtcclxuICAgICAgaWYgKG5vZGUudHlwZSA9PT0gJ2hlYWRpbmcnKSB7XHJcbiAgICAgICAgbm9kZS5kZXB0aCA9IHRoaXMub3B0aW9ucy5tYXJrZG93bi5oZWFkaW5nRGVwdGg7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKG5vZGUudHlwZSA9PT0gJ2NvZGUnKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNBUEkoYXN0LmNoaWxkcmVuW2luZGV4IC0gMV0pKSB7XHJcbiAgICAgICAgICBpZiAoIW5vZGUubGFuZykgbm9kZS5sYW5nID0gJ3hkb2MnO1xyXG4gICAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBub2RlO1xyXG4gICAgfSlcclxuICAgIHJldHVybiBhc3Q7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzQVBJID0gKG5vZGUpID0+IHtcclxuICAgIHJldHVybiBub2RlICYmIG5vZGUudHlwZSA9PT0gXCJoZWFkaW5nXCIgJiYgbm9kZS5jaGlsZHJlblswXS52YWx1ZS50b0xvd2VyQ2FzZSgpID09PSBcImFwaVwiO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwYXJzZVhEb2MgPSAoc291cmNlOiBzdHJpbmcpID0+IHtcclxuICAgIGNvbnN0IFhEb2NSZWdleCA9IC9AKFxcdyspKFtee1soXFxuXSopPyhbXFx7XFxbXFwoXVtcXHNcXFNdKltcXH1cXF1cXCldKFtcXHNdKig9fC0pPi4qKT8pPyhbXFxzXSotKC4pKik/L2dtaTtcclxuICAgIGNvbnN0IHN5bnRheGVzID0gc291cmNlLm1hdGNoKFhEb2NSZWdleCkgfHwgWycnXTtcclxuICAgIGNvbnN0IGRvY3VtZW50YXRpb24gPSAobmV3IFhEb2NBU1RHZW5lcmF0b3Ioc3ludGF4ZXMuam9pbignXFxuJykpKS5nZW5lcmF0ZSgpO1xyXG4gICAgcmV0dXJuIChuZXcgWERvY0FTVFZpc2l0b3IoZG9jdW1lbnRhdGlvbiwgdGhpcy5vcHRpb25zLnZpc2l0b3IpXHJcbiAgICAgIC52aXNpdCgpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBmaWx0ZXIgPSAodG9rZW46IFRva2VuKSA9PiB7XHJcbiAgICByZXR1cm4gVG9rZW5UeXBlW3Rva2VuLnR5cGVdID09PSB0aGlzLm9wdGlvbnMuY29tbWVudC50eXBlO1xyXG4gIH1cclxufSJdfQ==