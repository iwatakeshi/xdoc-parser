"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var TokenType;
(function (TokenType) {
    // EOF,
    TokenType[TokenType["SINGLE_HASH_COMMENT"] = 0] = "SINGLE_HASH_COMMENT";
    TokenType[TokenType["SINGLE_STAR_COMMENT"] = 1] = "SINGLE_STAR_COMMENT";
    TokenType[TokenType["DOUBLE_STAR_COMMENT"] = 2] = "DOUBLE_STAR_COMMENT";
    TokenType[TokenType["DOUBLE_SLASH_COMMENT"] = 3] = "DOUBLE_SLASH_COMMENT";
    TokenType[TokenType["TRIPLE_SLASH_COMMENT"] = 4] = "TRIPLE_SLASH_COMMENT";
    TokenType[TokenType["TRIPLE_QUOTE_COMMENT"] = 5] = "TRIPLE_QUOTE_COMMENT";
})(TokenType = exports.TokenType || (exports.TokenType = {}));
/**
 * Token is a class that tokenizes words and adds
 * useful information such as line and column number.
 *
 * # API
 *
 * ```
 * @class Token
 * @constructor (
 *  type: TokenType,
 *  text: string,
 *  line: number,
 *  column: number,
 *  position: number
 * ) => Token
 * ```
 */
class Token {
    constructor(type, text, line, column, position) {
        this.name_ = TokenType[type];
        this.type_ = type;
        this.text_ = text;
        this.line_ = line;
        this.column_ = column;
        this.position_ = position;
    }
    get name() {
        return this.name_;
    }
    get type() {
        return this.type_;
    }
    get text() {
        return this.text_;
    }
    get line() {
        return this.line_;
    }
    get column() {
        return this.column_;
    }
    get position() {
        return this.position_;
    }
    static getTokenName(type) {
        return TokenType[type];
    }
    static getTokenType(type) {
        return TokenType[type];
    }
}
exports.Token = Token;
/**
 * XDocCommentParser is a class that parses
 * c-style comments and python-style comments.
 *
 * # API
 *
 * ```
 * @constructor (source: string) => XDocCommentParser
 * ```
 *
 * # Remark
 * The parser can also parse double-star comments.
 *
 */
class XDocCommentParser {
    constructor(source) {
        this.tokens = [];
        this.position = this.start = 0;
        this.source = source.replace(/\r\n/g, '\n');
        this.line = 1;
        this.column = 1;
    }
    parse() {
        while (!this.isAtEnd()) {
            this.start = this.position;
            this.scan();
        }
        return this.tokens;
    }
    scan() {
        const ch = this.advance();
        switch (ch) {
            case '/':
                if (this.match('*')) {
                    let isDoubleStartComment = false;
                    if (this.match('*')) {
                        // Substring starts from here
                        this.start = this.position;
                        isDoubleStartComment = true;
                    }
                    else
                        this.start = this.position;
                    while ((this.peek() + this.peek(1)) !== '*/' && !this.isAtEnd())
                        this.advance();
                    this.addToken(isDoubleStartComment ? TokenType.DOUBLE_STAR_COMMENT : TokenType.SINGLE_STAR_COMMENT);
                    // consume '*/'
                    this.advance(2);
                }
                else if (this.match('/')) {
                    if (this.match('/')) {
                        // Substring starts from here
                        this.start = this.position;
                        while (this.peek() !== '\n' && !this.isAtEnd())
                            this.advance();
                        this.addToken(TokenType.TRIPLE_SLASH_COMMENT);
                        break;
                    }
                    // Substring starts from here
                    this.start = this.position;
                    while (this.peek() !== '\n' && !this.isAtEnd())
                        this.advance();
                    this.addToken(TokenType.DOUBLE_SLASH_COMMENT);
                }
                break;
            case '"':
                // Python-style multi-line comment
                if (this.peek() + this.peek(1) === '""') {
                    // consume '"""'
                    this.advance(2);
                    // Substring starts from here
                    this.start = this.position;
                    while (this.peek() + this.peek(1) + this.peek(2) !== '"""' && !this.isAtEnd())
                        this.advance();
                    this.addToken(TokenType.TRIPLE_QUOTE_COMMENT);
                    // consume '"""'
                    this.advance(3);
                }
                break;
            // Python/Bash-style single comment
            case '#':
                // Substring starts from here
                this.start = this.position;
                while (this.peek() !== '\n' && !this.isAtEnd())
                    this.advance();
                this.addToken(TokenType.SINGLE_HASH_COMMENT);
                this.advance();
                break;
        }
    }
    addToken(type) {
        let text = this.source.substring(this.start, this.position);
        // Process the dobule star comment
        if (type === TokenType.DOUBLE_STAR_COMMENT) {
            text = text.split('\n')
                .map(line => {
                // Replace the first '*' 
                let lineArray = line.replace(/[*]/, '').split('');
                if (lineArray[0] === ' ') {
                    lineArray.shift();
                    if (lineArray[0] === ' ') {
                        lineArray.shift();
                    }
                }
                return lineArray.join('');
            }).join('\n');
        }
        this.tokens.push(new Token(type, text, this.line, this.column, this.position));
    }
    peek(to = 0) {
        if (this.isAtEnd())
            return this.EOF;
        if (to > 0) {
            if (to + this.position > this.source.length)
                return this.EOF;
            return this.source.charAt(this.position + to);
        }
        return this.source.charAt(this.position);
    }
    advance(by = 0) {
        do {
            this.position++;
            if (this.peek() === '\n') {
                this.line++;
                this.column = 1;
            }
            else
                this.column++;
            if (this.isAtEnd())
                return this.EOF;
        } while (((by--) - 1) > 0);
        return this.source.charAt(this.position - 1);
    }
    match(expected) {
        if (this.isAtEnd())
            return false;
        if (this.source.charAt(this.position) !== expected)
            return false;
        this.position++;
        return true;
    }
    isAtEnd() {
        return this.position >= this.source.length;
    }
    get EOF() {
        return '\0';
    }
}
exports.default = XDocCommentParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWERvY0NvbW1lbnRQYXJzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvWERvY0NvbW1lbnRQYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFZLFNBUVg7QUFSRCxXQUFZLFNBQVM7SUFDbkIsT0FBTztJQUNQLHVFQUFtQixDQUFBO0lBQ25CLHVFQUFtQixDQUFBO0lBQ25CLHVFQUFtQixDQUFBO0lBQ25CLHlFQUFvQixDQUFBO0lBQ3BCLHlFQUFvQixDQUFBO0lBQ3BCLHlFQUFvQixDQUFBO0FBQ3RCLENBQUMsRUFSVyxTQUFTLEdBQVQsaUJBQVMsS0FBVCxpQkFBUyxRQVFwQjtBQUVEOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0FBQ0g7SUFRRSxZQUNFLElBQWUsRUFDZixJQUFZLEVBQ1osSUFBWSxFQUNaLE1BQWMsRUFDZCxRQUFnQjtRQUVoQixJQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztJQUM1QixDQUFDO0lBRUQsSUFBVyxJQUFJO1FBQ2IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxJQUFXLElBQUk7UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsSUFBVyxJQUFJO1FBQ2IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxJQUFXLE1BQU07UUFDZixP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QUksQ0FBQyxRQUFRLENBQUMsS0FBSyxRQUFRO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFDakUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLE9BQU87UUFDYixPQUFPLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDN0MsQ0FBQztJQUVELElBQVksR0FBRztRQUNiLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGO0FBckpELG9DQXFKQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBlbnVtIFRva2VuVHlwZSB7XG4gIC8vIEVPRixcbiAgU0lOR0xFX0hBU0hfQ09NTUVOVCxcbiAgU0lOR0xFX1NUQVJfQ09NTUVOVCxcbiAgRE9VQkxFX1NUQVJfQ09NTUVOVCxcbiAgRE9VQkxFX1NMQVNIX0NPTU1FTlQsXG4gIFRSSVBMRV9TTEFTSF9DT01NRU5ULFxuICBUUklQTEVfUVVPVEVfQ09NTUVOVFxufVxuXG4vKipcbiAqIFRva2VuIGlzIGEgY2xhc3MgdGhhdCB0b2tlbml6ZXMgd29yZHMgYW5kIGFkZHNcbiAqIHVzZWZ1bCBpbmZvcm1hdGlvbiBzdWNoIGFzIGxpbmUgYW5kIGNvbHVtbiBudW1iZXIuXG4gKiBcbiAqICMgQVBJXG4gKiBcbiAqIGBgYFxuICogQGNsYXNzIFRva2VuXG4gKiBAY29uc3RydWN0b3IgKFxuICogIHR5cGU6IFRva2VuVHlwZSxcbiAqICB0ZXh0OiBzdHJpbmcsXG4gKiAgbGluZTogbnVtYmVyLFxuICogIGNvbHVtbjogbnVtYmVyLFxuICogIHBvc2l0aW9uOiBudW1iZXJcbiAqICkgPT4gVG9rZW5cbiAqIGBgYFxuICovXG5leHBvcnQgY2xhc3MgVG9rZW4ge1xuICBwcml2YXRlIG5hbWVfOiBzdHJpbmc7XG4gIHByaXZhdGUgdHlwZV86IFRva2VuVHlwZTtcbiAgcHJpdmF0ZSB0ZXh0Xzogc3RyaW5nO1xuICBwcml2YXRlIGxpbmVfOiBudW1iZXI7XG4gIHByaXZhdGUgY29sdW1uXzogbnVtYmVyO1xuICBwcml2YXRlIHBvc2l0aW9uXzogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHR5cGU6IFRva2VuVHlwZSxcbiAgICB0ZXh0OiBzdHJpbmcsXG4gICAgbGluZTogbnVtYmVyLFxuICAgIGNvbHVtbjogbnVtYmVyLFxuICAgIHBvc2l0aW9uOiBudW1iZXJcbiAgKSB7XG4gICAgdGhpcy5uYW1lXyA9IFRva2VuVHlwZVt0eXBlXTtcbiAgICB0aGlzLnR5cGVfID0gdHlwZTtcbiAgICB0aGlzLnRleHRfID0gdGV4dDtcbiAgICB0aGlzLmxpbmVfID0gbGluZTtcbiAgICB0aGlzLmNvbHVtbl8gPSBjb2x1bW47XG4gICAgdGhpcy5wb3NpdGlvbl8gPSBwb3NpdGlvbjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm5hbWVfO1xuICB9XG5cbiAgcHVibGljIGdldCB0eXBlKCk6IFRva2VuVHlwZSB7XG4gICAgcmV0dXJuIHRoaXMudHlwZV87XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRleHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy50ZXh0XztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbGluZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmxpbmVfO1xuICB9XG5cbiAgcHVibGljIGdldCBjb2x1bW4oKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5jb2x1bW5fO1xuICB9XG5cbiAgcHVibGljIGdldCBwb3NpdGlvbigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnBvc2l0aW9uXztcbiAgfVxuXG4gIHN0YXRpYyBnZXRUb2tlbk5hbWUodHlwZTogVG9rZW5UeXBlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gVG9rZW5UeXBlW3R5cGVdO1xuICB9XG5cbiAgc3RhdGljIGdldFRva2VuVHlwZSh0eXBlOiBzdHJpbmcpOiBUb2tlblR5cGUge1xuICAgIHJldHVybiBUb2tlblR5cGVbdHlwZV07XG4gIH1cbn1cblxuLyoqXG4gKiBYRG9jQ29tbWVudFBhcnNlciBpcyBhIGNsYXNzIHRoYXQgcGFyc2VzXG4gKiBjLXN0eWxlIGNvbW1lbnRzIGFuZCBweXRob24tc3R5bGUgY29tbWVudHMuXG4gKiBcbiAqICMgQVBJXG4gKiBcbiAqIGBgYFxuICogQGNvbnN0cnVjdG9yIChzb3VyY2U6IHN0cmluZykgPT4gWERvY0NvbW1lbnRQYXJzZXJcbiAqIGBgYFxuICogXG4gKiAjIFJlbWFya1xuICogVGhlIHBhcnNlciBjYW4gYWxzbyBwYXJzZSBkb3VibGUtc3RhciBjb21tZW50cy5cbiAqIFxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBYRG9jQ29tbWVudFBhcnNlciB7XG4gIHByaXZhdGUgdG9rZW5zOiBUb2tlbltdO1xuICBwcml2YXRlIHN0YXJ0OiBudW1iZXI7XG4gIHByaXZhdGUgcG9zaXRpb246IG51bWJlcjtcbiAgcHJpdmF0ZSBzb3VyY2U6IHN0cmluZztcbiAgcHJpdmF0ZSBsaW5lOiBudW1iZXI7XG4gIHByaXZhdGUgY29sdW1uOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3Ioc291cmNlOiBzdHJpbmcpIHtcbiAgICB0aGlzLnRva2VucyA9IFtdO1xuICAgIHRoaXMucG9zaXRpb24gPSB0aGlzLnN0YXJ0ID0gMDtcbiAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZS5yZXBsYWNlKC9cXHJcXG4vZywgJ1xcbicpO1xuICAgIHRoaXMubGluZSA9IDE7XG4gICAgdGhpcy5jb2x1bW4gPSAxO1xuICB9XG5cbiAgcHVibGljIHBhcnNlKCkge1xuICAgIHdoaWxlICghdGhpcy5pc0F0RW5kKCkpIHtcbiAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuICAgICAgdGhpcy5zY2FuKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudG9rZW5zO1xuICB9XG5cbiAgcHJpdmF0ZSBzY2FuKCkge1xuICAgIGNvbnN0IGNoID0gdGhpcy5hZHZhbmNlKCk7XG4gICAgc3dpdGNoIChjaCkge1xuICAgICAgY2FzZSAnLyc6XG4gICAgICAgIGlmICh0aGlzLm1hdGNoKCcqJykpIHtcbiAgICAgICAgICBsZXQgaXNEb3VibGVTdGFydENvbW1lbnQgPSBmYWxzZTtcbiAgICAgICAgICBpZiAodGhpcy5tYXRjaCgnKicpKSB7XG4gICAgICAgICAgICAvLyBTdWJzdHJpbmcgc3RhcnRzIGZyb20gaGVyZVxuICAgICAgICAgICAgdGhpcy5zdGFydCA9IHRoaXMucG9zaXRpb25cbiAgICAgICAgICAgIGlzRG91YmxlU3RhcnRDb21tZW50ID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2UgdGhpcy5zdGFydCA9IHRoaXMucG9zaXRpb247XG5cbiAgICAgICAgICB3aGlsZSAoKHRoaXMucGVlaygpICsgdGhpcy5wZWVrKDEpKSAhPT0gJyovJyAmJiAhdGhpcy5pc0F0RW5kKCkpIHRoaXMuYWR2YW5jZSgpO1xuXG4gICAgICAgICAgdGhpcy5hZGRUb2tlbihpc0RvdWJsZVN0YXJ0Q29tbWVudCA/IFRva2VuVHlwZS5ET1VCTEVfU1RBUl9DT01NRU5UIDogVG9rZW5UeXBlLlNJTkdMRV9TVEFSX0NPTU1FTlQpXG5cbiAgICAgICAgICAvLyBjb25zdW1lICcqLydcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoMik7XG5cbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1hdGNoKCcvJykpIHtcblxuICAgICAgICAgIGlmICh0aGlzLm1hdGNoKCcvJykpIHtcbiAgICAgICAgICAgIC8vIFN1YnN0cmluZyBzdGFydHMgZnJvbSBoZXJlXG4gICAgICAgICAgICB0aGlzLnN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcbiAgICAgICAgICAgIHdoaWxlICh0aGlzLnBlZWsoKSAhPT0gJ1xcbicgJiYgIXRoaXMuaXNBdEVuZCgpKSB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgICAgIHRoaXMuYWRkVG9rZW4oVG9rZW5UeXBlLlRSSVBMRV9TTEFTSF9DT01NRU5UKVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIFN1YnN0cmluZyBzdGFydHMgZnJvbSBoZXJlXG4gICAgICAgICAgdGhpcy5zdGFydCA9IHRoaXMucG9zaXRpb247XG5cbiAgICAgICAgICB3aGlsZSAodGhpcy5wZWVrKCkgIT09ICdcXG4nICYmICF0aGlzLmlzQXRFbmQoKSkgdGhpcy5hZHZhbmNlKCk7XG5cbiAgICAgICAgICB0aGlzLmFkZFRva2VuKFRva2VuVHlwZS5ET1VCTEVfU0xBU0hfQ09NTUVOVCk7XG4gICAgICAgIH1cblxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1wiJzpcbiAgICAgICAgLy8gUHl0aG9uLXN0eWxlIG11bHRpLWxpbmUgY29tbWVudFxuICAgICAgICBpZiAodGhpcy5wZWVrKCkgKyB0aGlzLnBlZWsoMSkgPT09ICdcIlwiJykge1xuICAgICAgICAgIC8vIGNvbnN1bWUgJ1wiXCJcIidcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoMik7XG4gICAgICAgICAgLy8gU3Vic3RyaW5nIHN0YXJ0cyBmcm9tIGhlcmVcbiAgICAgICAgICB0aGlzLnN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcblxuICAgICAgICAgIHdoaWxlICh0aGlzLnBlZWsoKSArIHRoaXMucGVlaygxKSArIHRoaXMucGVlaygyKSAhPT0gJ1wiXCJcIicgJiYgIXRoaXMuaXNBdEVuZCgpKSB0aGlzLmFkdmFuY2UoKTtcblxuICAgICAgICAgIHRoaXMuYWRkVG9rZW4oVG9rZW5UeXBlLlRSSVBMRV9RVU9URV9DT01NRU5UKTtcblxuICAgICAgICAgIC8vIGNvbnN1bWUgJ1wiXCJcIidcbiAgICAgICAgICB0aGlzLmFkdmFuY2UoMyk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICAvLyBQeXRob24vQmFzaC1zdHlsZSBzaW5nbGUgY29tbWVudFxuICAgICAgY2FzZSAnIyc6XG4gICAgICAgIC8vIFN1YnN0cmluZyBzdGFydHMgZnJvbSBoZXJlXG4gICAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuICAgICAgICB3aGlsZSAodGhpcy5wZWVrKCkgIT09ICdcXG4nICYmICF0aGlzLmlzQXRFbmQoKSkgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgIHRoaXMuYWRkVG9rZW4oVG9rZW5UeXBlLlNJTkdMRV9IQVNIX0NPTU1FTlQpO1xuICAgICAgICB0aGlzLmFkdmFuY2UoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRUb2tlbih0eXBlOiBUb2tlblR5cGUpIHtcbiAgICBsZXQgdGV4dCA9IHRoaXMuc291cmNlLnN1YnN0cmluZyh0aGlzLnN0YXJ0LCB0aGlzLnBvc2l0aW9uKTtcblxuICAgIC8vIFByb2Nlc3MgdGhlIGRvYnVsZSBzdGFyIGNvbW1lbnRcbiAgICBpZiAodHlwZSA9PT0gVG9rZW5UeXBlLkRPVUJMRV9TVEFSX0NPTU1FTlQpIHtcblxuICAgICAgdGV4dCA9IHRleHQuc3BsaXQoJ1xcbicpXG4gICAgICAgIC5tYXAobGluZSA9PiB7XG4gICAgICAgICAgLy8gUmVwbGFjZSB0aGUgZmlyc3QgJyonIFxuICAgICAgICAgIGxldCBsaW5lQXJyYXkgPSBsaW5lLnJlcGxhY2UoL1sqXS8sICcnKS5zcGxpdCgnJylcbiAgICAgICAgICBpZiAobGluZUFycmF5WzBdID09PSAnICcpIHtcbiAgICAgICAgICAgIGxpbmVBcnJheS5zaGlmdCgpO1xuICAgICAgICAgICAgaWYgKGxpbmVBcnJheVswXSA9PT0gJyAnKSB7XG4gICAgICAgICAgICAgIGxpbmVBcnJheS5zaGlmdCgpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBsaW5lQXJyYXkuam9pbignJyk7XG4gICAgICAgIH0pLmpvaW4oJ1xcbicpXG4gICAgfVxuXG4gICAgdGhpcy50b2tlbnMucHVzaChuZXcgVG9rZW4odHlwZSwgdGV4dCwgdGhpcy5saW5lLCB0aGlzLmNvbHVtbiwgdGhpcy5wb3NpdGlvbikpO1xuICB9XG5cbiAgcHJpdmF0ZSBwZWVrKHRvID0gMCkge1xuICAgIGlmICh0aGlzLmlzQXRFbmQoKSkgcmV0dXJuIHRoaXMuRU9GO1xuICAgIGlmICh0byA+IDApIHtcbiAgICAgIGlmICh0byArIHRoaXMucG9zaXRpb24gPiB0aGlzLnNvdXJjZS5sZW5ndGgpIHJldHVybiB0aGlzLkVPRjtcbiAgICAgIHJldHVybiB0aGlzLnNvdXJjZS5jaGFyQXQodGhpcy5wb3NpdGlvbiArIHRvKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc291cmNlLmNoYXJBdCh0aGlzLnBvc2l0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgYWR2YW5jZShieSA9IDApIHtcbiAgICBkbyB7XG4gICAgICB0aGlzLnBvc2l0aW9uKys7XG4gICAgICBpZiAodGhpcy5wZWVrKCkgPT09ICdcXG4nKSB7XG4gICAgICAgIHRoaXMubGluZSsrO1xuICAgICAgICB0aGlzLmNvbHVtbiA9IDE7XG4gICAgICB9IGVsc2UgdGhpcy5jb2x1bW4rKztcblxuICAgICAgaWYgKHRoaXMuaXNBdEVuZCgpKSByZXR1cm4gdGhpcy5FT0Y7XG4gICAgfSB3aGlsZSAoKChieS0tKSAtIDEpID4gMClcblxuICAgIHJldHVybiB0aGlzLnNvdXJjZS5jaGFyQXQodGhpcy5wb3NpdGlvbiAtIDEpO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXRjaChleHBlY3RlZCkge1xuICAgIGlmICh0aGlzLmlzQXRFbmQoKSkgcmV0dXJuIGZhbHNlO1xuICAgIGlmICh0aGlzLnNvdXJjZS5jaGFyQXQodGhpcy5wb3NpdGlvbikgIT09IGV4cGVjdGVkKSByZXR1cm4gZmFsc2U7XG4gICAgdGhpcy5wb3NpdGlvbisrO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0F0RW5kKCkge1xuICAgIHJldHVybiB0aGlzLnBvc2l0aW9uID49IHRoaXMuc291cmNlLmxlbmd0aDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IEVPRigpIHtcbiAgICByZXR1cm4gJ1xcMCc7XG4gIH1cbn0iXX0=