"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var TokenType;
(function (TokenType) {
    // EOF,
    TokenType[TokenType["SINGLE_HASH_COMMENT"] = 0] = "SINGLE_HASH_COMMENT";
    TokenType[TokenType["SINGLE_STAR_COMMENT"] = 1] = "SINGLE_STAR_COMMENT";
    TokenType[TokenType["DOUBLE_STAR_COMMENT"] = 2] = "DOUBLE_STAR_COMMENT";
    TokenType[TokenType["DOUBLE_SLASH_COMMENT"] = 3] = "DOUBLE_SLASH_COMMENT";
    TokenType[TokenType["TRIPLE_SLASH_COMMENT"] = 4] = "TRIPLE_SLASH_COMMENT";
    TokenType[TokenType["TRIPLE_QUOTE_COMMENT"] = 5] = "TRIPLE_QUOTE_COMMENT";
})(TokenType = exports.TokenType || (exports.TokenType = {}));
/**
 * Token is a class that tokenizes words and adds
 * useful information such as line and column number.
 *
 * # API
 *
 * ```
 * @class Token
 * @constructor (
 *  type: TokenType,
 *  text: string,
 *  line: number,
 *  column: number,
 *  position: number
 * ) => Token
 * ```
 */
class Token {
    constructor(type, text, line, column, position) {
        this.name_ = TokenType[type];
        this.type_ = type;
        this.text_ = text;
        this.line_ = line;
        this.column_ = column;
        this.position_ = position;
    }
    get name() {
        return this.name_;
    }
    get type() {
        return this.type_;
    }
    get text() {
        return this.text_;
    }
    get line() {
        return this.line_;
    }
    get column() {
        return this.column_;
    }
    get position() {
        return this.position_;
    }
    static getTokenName(type) {
        return TokenType[type];
    }
    static getTokenType(type) {
        return TokenType[type];
    }
}
exports.Token = Token;
/**
 * XDocCommentParser is a class that parses
 * c-style comments and python-style comments.
 *
 * # API
 *
 * ```
 * @constructor (source: string) => XDocCommentParser
 * ```
 *
 * # Remark
 * The parser can also parse double-star comments.
 *
 */
class XDocCommentParser {
    constructor(source) {
        this.tokens = [];
        this.position = this.start = 0;
        this.source = source.replace(/\r\n/g, '\n');
        this.line = 1;
        this.column = 1;
    }
    parse() {
        while (!this.isAtEnd()) {
            this.start = this.position;
            this.scan();
        }
        return this.tokens;
    }
    scan() {
        const ch = this.advance();
        switch (ch) {
            case '/':
                if (this.match('*')) {
                    let isDoubleStartComment = false;
                    if (this.match('*')) {
                        // Substring starts from here
                        this.start = this.position;
                        isDoubleStartComment = true;
                    }
                    else
                        this.start = this.position;
                    while ((this.peek() + this.peek(1)) !== '*/' && !this.isAtEnd())
                        this.advance();
                    this.addToken(isDoubleStartComment ? TokenType.DOUBLE_STAR_COMMENT : TokenType.SINGLE_STAR_COMMENT);
                    // consume '*/'
                    this.advance(2);
                }
                else if (this.match('/')) {
                    if (this.match('/')) {
                        // Substring starts from here
                        this.start = this.position;
                        while (this.peek() !== '\n' && !this.isAtEnd())
                            this.advance();
                        this.addToken(TokenType.TRIPLE_SLASH_COMMENT);
                        break;
                    }
                    // Substring starts from here
                    this.start = this.position;
                    while (this.peek() !== '\n' && !this.isAtEnd())
                        this.advance();
                    this.addToken(TokenType.DOUBLE_SLASH_COMMENT);
                }
                break;
            case '"':
                // Python-style multi-line comment
                if (this.peek() + this.peek(1) === '""') {
                    // consume '"""'
                    this.advance(2);
                    // Substring starts from here
                    this.start = this.position;
                    while (this.peek() + this.peek(1) + this.peek(2) !== '"""' && !this.isAtEnd())
                        this.advance();
                    this.addToken(TokenType.TRIPLE_QUOTE_COMMENT);
                    // consume '"""'
                    this.advance(3);
                }
                break;
            // Python/Bash-style single comment
            case '#':
                // Substring starts from here
                this.start = this.position;
                while (this.peek() !== '\n' && !this.isAtEnd())
                    this.advance();
                this.addToken(TokenType.SINGLE_HASH_COMMENT);
                this.advance();
                break;
        }
    }
    addToken(type) {
        let text = this.source.substring(this.start, this.position);
        // Process the dobule star comment
        if (type === TokenType.DOUBLE_STAR_COMMENT) {
            text = text.split('\n')
                .map(line => {
                // Replace the first '*' 
                let lineArray = line.replace(/[*]/, '').split('');
                if (lineArray[0] === ' ') {
                    lineArray.shift();
                    if (lineArray[0] === ' ') {
                        lineArray.shift();
                    }
                }
                return lineArray.join('');
            }).join('\n');
        }
        this.tokens.push(new Token(type, text, this.line, this.column, this.position));
    }
    peek(to = 0) {
        if (this.isAtEnd())
            return this.EOF;
        if (to > 0) {
            if (to + this.position > this.source.length)
                return this.EOF;
            return this.source.charAt(this.position + to);
        }
        return this.source.charAt(this.position);
    }
    advance(by = 0) {
        do {
            this.position++;
            if (this.peek() === '\n') {
                this.line++;
                this.column = 1;
            }
            else
                this.column++;
            if (this.isAtEnd())
                return this.EOF;
        } while (((by--) - 1) > 0);
        return this.source.charAt(this.position - 1);
    }
    match(expected) {
        if (this.isAtEnd())
            return false;
        if (this.source.charAt(this.position) !== expected)
            return false;
        this.position++;
        return true;
    }
    isAtEnd() {
        return this.position >= this.source.length;
    }
    get EOF() {
        return '\0';
    }
}
exports.default = XDocCommentParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWERvY0NvbW1lbnRQYXJzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvWERvY0NvbW1lbnRQYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFZLFNBUVg7QUFSRCxXQUFZLFNBQVM7SUFDbkIsT0FBTztJQUNQLHVFQUFtQixDQUFBO0lBQ25CLHVFQUFtQixDQUFBO0lBQ25CLHVFQUFtQixDQUFBO0lBQ25CLHlFQUFvQixDQUFBO0lBQ3BCLHlFQUFvQixDQUFBO0lBQ3BCLHlFQUFvQixDQUFBO0FBQ3RCLENBQUMsRUFSVyxTQUFTLEdBQVQsaUJBQVMsS0FBVCxpQkFBUyxRQVFwQjtBQUVEOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0FBQ0gsTUFBYSxLQUFLO0lBUWhCLFlBQ0UsSUFBZSxFQUNmLElBQVksRUFDWixJQUFZLEVBQ1osTUFBYyxFQUNkLFFBQWdCO1FBRWhCLElBQUksQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFXLElBQUk7UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsSUFBVyxJQUFJO1FBQ2IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxJQUFXLElBQUk7UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQVcs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QUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssUUFBUTtZQUFFLE9BQU8sS0FBSyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTyxPQUFPO1FBQ2IsT0FBTyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQzdDLENBQUM7SUFFRCxJQUFZLEdBQUc7UUFDYixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRjtBQXJKRCxvQ0FxSkMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZW51bSBUb2tlblR5cGUge1xuICAvLyBFT0YsXG4gIFNJTkdMRV9IQVNIX0NPTU1FTlQsXG4gIFNJTkdMRV9TVEFSX0NPTU1FTlQsXG4gIERPVUJMRV9TVEFSX0NPTU1FTlQsXG4gIERPVUJMRV9TTEFTSF9DT01NRU5ULFxuICBUUklQTEVfU0xBU0hfQ09NTUVOVCxcbiAgVFJJUExFX1FVT1RFX0NPTU1FTlRcbn1cblxuLyoqXG4gKiBUb2tlbiBpcyBhIGNsYXNzIHRoYXQgdG9rZW5pemVzIHdvcmRzIGFuZCBhZGRzXG4gKiB1c2VmdWwgaW5mb3JtYXRpb24gc3VjaCBhcyBsaW5lIGFuZCBjb2x1bW4gbnVtYmVyLlxuICogXG4gKiAjIEFQSVxuICogXG4gKiBgYGBcbiAqIEBjbGFzcyBUb2tlblxuICogQGNvbnN0cnVjdG9yIChcbiAqICB0eXBlOiBUb2tlblR5cGUsXG4gKiAgdGV4dDogc3RyaW5nLFxuICogIGxpbmU6IG51bWJlcixcbiAqICBjb2x1bW46IG51bWJlcixcbiAqICBwb3NpdGlvbjogbnVtYmVyXG4gKiApID0+IFRva2VuXG4gKiBgYGBcbiAqL1xuZXhwb3J0IGNsYXNzIFRva2VuIHtcbiAgcHJpdmF0ZSBuYW1lXzogc3RyaW5nO1xuICBwcml2YXRlIHR5cGVfOiBUb2tlblR5cGU7XG4gIHByaXZhdGUgdGV4dF86IHN0cmluZztcbiAgcHJpdmF0ZSBsaW5lXzogbnVtYmVyO1xuICBwcml2YXRlIGNvbHVtbl86IG51bWJlcjtcbiAgcHJpdmF0ZSBwb3NpdGlvbl86IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICB0eXBlOiBUb2tlblR5cGUsXG4gICAgdGV4dDogc3RyaW5nLFxuICAgIGxpbmU6IG51bWJlcixcbiAgICBjb2x1bW46IG51bWJlcixcbiAgICBwb3NpdGlvbjogbnVtYmVyXG4gICkge1xuICAgIHRoaXMubmFtZV8gPSBUb2tlblR5cGVbdHlwZV07XG4gICAgdGhpcy50eXBlXyA9IHR5cGU7XG4gICAgdGhpcy50ZXh0XyA9IHRleHQ7XG4gICAgdGhpcy5saW5lXyA9IGxpbmU7XG4gICAgdGhpcy5jb2x1bW5fID0gY29sdW1uO1xuICAgIHRoaXMucG9zaXRpb25fID0gcG9zaXRpb247XG4gIH1cblxuICBwdWJsaWMgZ2V0IG5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5uYW1lXztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdHlwZSgpOiBUb2tlblR5cGUge1xuICAgIHJldHVybiB0aGlzLnR5cGVfO1xuICB9XG5cbiAgcHVibGljIGdldCB0ZXh0KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMudGV4dF87XG4gIH1cblxuICBwdWJsaWMgZ2V0IGxpbmUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5saW5lXztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY29sdW1uKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY29sdW1uXztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcG9zaXRpb24oKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5wb3NpdGlvbl87XG4gIH1cblxuICBzdGF0aWMgZ2V0VG9rZW5OYW1lKHR5cGU6IFRva2VuVHlwZSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFRva2VuVHlwZVt0eXBlXTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRUb2tlblR5cGUodHlwZTogc3RyaW5nKTogVG9rZW5UeXBlIHtcbiAgICByZXR1cm4gVG9rZW5UeXBlW3R5cGVdO1xuICB9XG59XG5cbi8qKlxuICogWERvY0NvbW1lbnRQYXJzZXIgaXMgYSBjbGFzcyB0aGF0IHBhcnNlc1xuICogYy1zdHlsZSBjb21tZW50cyBhbmQgcHl0aG9uLXN0eWxlIGNvbW1lbnRzLlxuICogXG4gKiAjIEFQSVxuICogXG4gKiBgYGBcbiAqIEBjb25zdHJ1Y3RvciAoc291cmNlOiBzdHJpbmcpID0+IFhEb2NDb21tZW50UGFyc2VyXG4gKiBgYGBcbiAqIFxuICogIyBSZW1hcmtcbiAqIFRoZSBwYXJzZXIgY2FuIGFsc28gcGFyc2UgZG91YmxlLXN0YXIgY29tbWVudHMuXG4gKiBcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgWERvY0NvbW1lbnRQYXJzZXIge1xuICBwcml2YXRlIHRva2VuczogVG9rZW5bXTtcbiAgcHJpdmF0ZSBzdGFydDogbnVtYmVyO1xuICBwcml2YXRlIHBvc2l0aW9uOiBudW1iZXI7XG4gIHByaXZhdGUgc291cmNlOiBzdHJpbmc7XG4gIHByaXZhdGUgbGluZTogbnVtYmVyO1xuICBwcml2YXRlIGNvbHVtbjogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKHNvdXJjZTogc3RyaW5nKSB7XG4gICAgdGhpcy50b2tlbnMgPSBbXTtcbiAgICB0aGlzLnBvc2l0aW9uID0gdGhpcy5zdGFydCA9IDA7XG4gICAgdGhpcy5zb3VyY2UgPSBzb3VyY2UucmVwbGFjZSgvXFxyXFxuL2csICdcXG4nKTtcbiAgICB0aGlzLmxpbmUgPSAxO1xuICAgIHRoaXMuY29sdW1uID0gMTtcbiAgfVxuXG4gIHB1YmxpYyBwYXJzZSgpIHtcbiAgICB3aGlsZSAoIXRoaXMuaXNBdEVuZCgpKSB7XG4gICAgICB0aGlzLnN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcbiAgICAgIHRoaXMuc2NhbigpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRva2VucztcbiAgfVxuXG4gIHByaXZhdGUgc2NhbigpIHtcbiAgICBjb25zdCBjaCA9IHRoaXMuYWR2YW5jZSgpO1xuICAgIHN3aXRjaCAoY2gpIHtcbiAgICAgIGNhc2UgJy8nOlxuICAgICAgICBpZiAodGhpcy5tYXRjaCgnKicpKSB7XG4gICAgICAgICAgbGV0IGlzRG91YmxlU3RhcnRDb21tZW50ID0gZmFsc2U7XG4gICAgICAgICAgaWYgKHRoaXMubWF0Y2goJyonKSkge1xuICAgICAgICAgICAgLy8gU3Vic3RyaW5nIHN0YXJ0cyBmcm9tIGhlcmVcbiAgICAgICAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLnBvc2l0aW9uXG4gICAgICAgICAgICBpc0RvdWJsZVN0YXJ0Q29tbWVudCA9IHRydWU7XG4gICAgICAgICAgfSBlbHNlIHRoaXMuc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuXG4gICAgICAgICAgd2hpbGUgKCh0aGlzLnBlZWsoKSArIHRoaXMucGVlaygxKSkgIT09ICcqLycgJiYgIXRoaXMuaXNBdEVuZCgpKSB0aGlzLmFkdmFuY2UoKTtcblxuICAgICAgICAgIHRoaXMuYWRkVG9rZW4oaXNEb3VibGVTdGFydENvbW1lbnQgPyBUb2tlblR5cGUuRE9VQkxFX1NUQVJfQ09NTUVOVCA6IFRva2VuVHlwZS5TSU5HTEVfU1RBUl9DT01NRU5UKVxuXG4gICAgICAgICAgLy8gY29uc3VtZSAnKi8nXG4gICAgICAgICAgdGhpcy5hZHZhbmNlKDIpO1xuXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5tYXRjaCgnLycpKSB7XG5cbiAgICAgICAgICBpZiAodGhpcy5tYXRjaCgnLycpKSB7XG4gICAgICAgICAgICAvLyBTdWJzdHJpbmcgc3RhcnRzIGZyb20gaGVyZVxuICAgICAgICAgICAgdGhpcy5zdGFydCA9IHRoaXMucG9zaXRpb247XG4gICAgICAgICAgICB3aGlsZSAodGhpcy5wZWVrKCkgIT09ICdcXG4nICYmICF0aGlzLmlzQXRFbmQoKSkgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgICAgICB0aGlzLmFkZFRva2VuKFRva2VuVHlwZS5UUklQTEVfU0xBU0hfQ09NTUVOVClcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBTdWJzdHJpbmcgc3RhcnRzIGZyb20gaGVyZVxuICAgICAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLnBvc2l0aW9uO1xuXG4gICAgICAgICAgd2hpbGUgKHRoaXMucGVlaygpICE9PSAnXFxuJyAmJiAhdGhpcy5pc0F0RW5kKCkpIHRoaXMuYWR2YW5jZSgpO1xuXG4gICAgICAgICAgdGhpcy5hZGRUb2tlbihUb2tlblR5cGUuRE9VQkxFX1NMQVNIX0NPTU1FTlQpO1xuICAgICAgICB9XG5cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdcIic6XG4gICAgICAgIC8vIFB5dGhvbi1zdHlsZSBtdWx0aS1saW5lIGNvbW1lbnRcbiAgICAgICAgaWYgKHRoaXMucGVlaygpICsgdGhpcy5wZWVrKDEpID09PSAnXCJcIicpIHtcbiAgICAgICAgICAvLyBjb25zdW1lICdcIlwiXCInXG4gICAgICAgICAgdGhpcy5hZHZhbmNlKDIpO1xuICAgICAgICAgIC8vIFN1YnN0cmluZyBzdGFydHMgZnJvbSBoZXJlXG4gICAgICAgICAgdGhpcy5zdGFydCA9IHRoaXMucG9zaXRpb247XG5cbiAgICAgICAgICB3aGlsZSAodGhpcy5wZWVrKCkgKyB0aGlzLnBlZWsoMSkgKyB0aGlzLnBlZWsoMikgIT09ICdcIlwiXCInICYmICF0aGlzLmlzQXRFbmQoKSkgdGhpcy5hZHZhbmNlKCk7XG5cbiAgICAgICAgICB0aGlzLmFkZFRva2VuKFRva2VuVHlwZS5UUklQTEVfUVVPVEVfQ09NTUVOVCk7XG5cbiAgICAgICAgICAvLyBjb25zdW1lICdcIlwiXCInXG4gICAgICAgICAgdGhpcy5hZHZhbmNlKDMpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgLy8gUHl0aG9uL0Jhc2gtc3R5bGUgc2luZ2xlIGNvbW1lbnRcbiAgICAgIGNhc2UgJyMnOlxuICAgICAgICAvLyBTdWJzdHJpbmcgc3RhcnRzIGZyb20gaGVyZVxuICAgICAgICB0aGlzLnN0YXJ0ID0gdGhpcy5wb3NpdGlvbjtcbiAgICAgICAgd2hpbGUgKHRoaXMucGVlaygpICE9PSAnXFxuJyAmJiAhdGhpcy5pc0F0RW5kKCkpIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgICB0aGlzLmFkZFRva2VuKFRva2VuVHlwZS5TSU5HTEVfSEFTSF9DT01NRU5UKTtcbiAgICAgICAgdGhpcy5hZHZhbmNlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkVG9rZW4odHlwZTogVG9rZW5UeXBlKSB7XG4gICAgbGV0IHRleHQgPSB0aGlzLnNvdXJjZS5zdWJzdHJpbmcodGhpcy5zdGFydCwgdGhpcy5wb3NpdGlvbik7XG5cbiAgICAvLyBQcm9jZXNzIHRoZSBkb2J1bGUgc3RhciBjb21tZW50XG4gICAgaWYgKHR5cGUgPT09IFRva2VuVHlwZS5ET1VCTEVfU1RBUl9DT01NRU5UKSB7XG5cbiAgICAgIHRleHQgPSB0ZXh0LnNwbGl0KCdcXG4nKVxuICAgICAgICAubWFwKGxpbmUgPT4ge1xuICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGZpcnN0ICcqJyBcbiAgICAgICAgICBsZXQgbGluZUFycmF5ID0gbGluZS5yZXBsYWNlKC9bKl0vLCAnJykuc3BsaXQoJycpXG4gICAgICAgICAgaWYgKGxpbmVBcnJheVswXSA9PT0gJyAnKSB7XG4gICAgICAgICAgICBsaW5lQXJyYXkuc2hpZnQoKTtcbiAgICAgICAgICAgIGlmIChsaW5lQXJyYXlbMF0gPT09ICcgJykge1xuICAgICAgICAgICAgICBsaW5lQXJyYXkuc2hpZnQoKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gbGluZUFycmF5LmpvaW4oJycpO1xuICAgICAgICB9KS5qb2luKCdcXG4nKVxuICAgIH1cblxuICAgIHRoaXMudG9rZW5zLnB1c2gobmV3IFRva2VuKHR5cGUsIHRleHQsIHRoaXMubGluZSwgdGhpcy5jb2x1bW4sIHRoaXMucG9zaXRpb24pKTtcbiAgfVxuXG4gIHByaXZhdGUgcGVlayh0byA9IDApIHtcbiAgICBpZiAodGhpcy5pc0F0RW5kKCkpIHJldHVybiB0aGlzLkVPRjtcbiAgICBpZiAodG8gPiAwKSB7XG4gICAgICBpZiAodG8gKyB0aGlzLnBvc2l0aW9uID4gdGhpcy5zb3VyY2UubGVuZ3RoKSByZXR1cm4gdGhpcy5FT0Y7XG4gICAgICByZXR1cm4gdGhpcy5zb3VyY2UuY2hhckF0KHRoaXMucG9zaXRpb24gKyB0byk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnNvdXJjZS5jaGFyQXQodGhpcy5wb3NpdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGFkdmFuY2UoYnkgPSAwKSB7XG4gICAgZG8ge1xuICAgICAgdGhpcy5wb3NpdGlvbisrO1xuICAgICAgaWYgKHRoaXMucGVlaygpID09PSAnXFxuJykge1xuICAgICAgICB0aGlzLmxpbmUrKztcbiAgICAgICAgdGhpcy5jb2x1bW4gPSAxO1xuICAgICAgfSBlbHNlIHRoaXMuY29sdW1uKys7XG5cbiAgICAgIGlmICh0aGlzLmlzQXRFbmQoKSkgcmV0dXJuIHRoaXMuRU9GO1xuICAgIH0gd2hpbGUgKCgoYnktLSkgLSAxKSA+IDApXG5cbiAgICByZXR1cm4gdGhpcy5zb3VyY2UuY2hhckF0KHRoaXMucG9zaXRpb24gLSAxKTtcbiAgfVxuXG4gIHByaXZhdGUgbWF0Y2goZXhwZWN0ZWQpIHtcbiAgICBpZiAodGhpcy5pc0F0RW5kKCkpIHJldHVybiBmYWxzZTtcbiAgICBpZiAodGhpcy5zb3VyY2UuY2hhckF0KHRoaXMucG9zaXRpb24pICE9PSBleHBlY3RlZCkgcmV0dXJuIGZhbHNlO1xuICAgIHRoaXMucG9zaXRpb24rKztcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgaXNBdEVuZCgpIHtcbiAgICByZXR1cm4gdGhpcy5wb3NpdGlvbiA+PSB0aGlzLnNvdXJjZS5sZW5ndGg7XG4gIH1cblxuICBwcml2YXRlIGdldCBFT0YoKSB7XG4gICAgcmV0dXJuICdcXDAnO1xuICB9XG59Il19